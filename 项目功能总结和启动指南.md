# Web_TKS 项目功能总结和启动指南

## 📋 项目功能总结

### 项目概述
Web_TKS 是一个基于 FastAPI 的智能检测系统后端，主要用于工厂车间的视频监控、AI检测和事件管理。系统通过摄像头实时监控车间，使用AI模型进行多种检测任务，并通过WebSocket和MQTT实现实时数据推送。

### 核心功能模块

#### 1. 系统管理模块
- **用户管理**: 用户的增删改查、状态管理、密码重置
- **权限管理**: 基于RBAC的角色和权限管理
- **参数设置**: 系统全局参数配置（检测灵敏度、告警阈值等）
- **摄像头管理**: 摄像头的添加、编辑、删除、状态监控、连接测试
- **事件推送设置**: 配置事件推送规则（MQTT、企业微信等）

#### 2. 检测区域设置模块
- **脱岗区域设置**: 配置操作人员脱岗检测的区域和规则
- **换车区域设置**: 配置布车更换区域的监控参数
- **危险区域设置**: 配置危险区域的检测规则
- 支持按摄像头、机台、区域类型进行筛选和管理

#### 3. 模型管理模块
- **模型上传**: 支持AI模型文件上传（如YOLOv8模型）
- **模型版本管理**: 模型版本控制和管理
- **模型类型管理**: 定义和管理不同类型的检测模型（布车检测、人员检测等）

#### 4. 检测功能模块
- **布车检测**: 实时检测车间布车分布、状态、位置信息
- **脱岗检测**: 检测操作人员是否在指定区域，记录脱岗时间和时长
- **换车检测**: 检测布车更换过程，记录新旧车辆信息
- **危险区域检测**: 检测人员是否进入危险区域，触发告警
- **通道出入检测**: 检测车辆和人员的通道出入记录

#### 5. 事件和视频查询模块
- **事件查询**: 查询各类检测事件，支持筛选、统计、导出
- **视频查询**: 实时视频流、历史回放、录像下载、快照获取
- **视频布局**: 支持多分屏布局配置

#### 6. 实时通信
- **WebSocket**: 实时推送检测数据、事件通知、检测结果
- **MQTT**: 与MES系统集成，推送换车信息、告警等

### 技术栈
- **前端框架**: Vue 3
- **类型系统**: TypeScript 5
- **状态管理**: Pinia
- **路由**: Vue Router 4
- **UI组件库**: Ant Design Vue
- **HTTP客户端**: Axios
- **样式方案**: CSS Modules / SCSS
- **构建工具**: Vite
- **实时通信**: Socket.IO Client
- **视频播放**: video.js
- **后端框架**: FastAPI 0.109+
- **数据库**: MySQL (使用asyncmy异步驱动)
- **ORM**: SQLAlchemy 2.0+ (异步)
- **认证**: JWT Token
- **实时通信**: WebSocket, MQTT
- **数据验证**: Pydantic 2.0+

---

## 🚀 MySQL数据库启动指南

### 前置要求
1. Python 3.11+
2. MySQL 5.7+ 或 MySQL 8.0+
3. Redis (可选，用于缓存)

### 步骤1: 安装Python依赖

```bash
cd backend
pip install -r requirements.txt
```

### 步骤2: 创建MySQL数据库

在MySQL中创建数据库：

```sql
CREATE DATABASE web_tks CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### 步骤3: 配置环境变量

在 `backend` 目录下创建 `.env` 文件（参考 `.env.example`）：

```bash
# 复制示例文件
cp .env.example .env
```

编辑 `.env` 文件，配置你的MySQL连接信息：

```env
# 数据库配置
DB_TYPE=mysql
DB_SERVER=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_mysql_password
DB_NAME=web_tks

# 其他配置...
SECRET_KEY=your-secret-key-here
```

### 步骤4: 启动项目

```bash
cd backend
python main.py
```

或者使用uvicorn直接启动：

```bash
cd backend
uvicorn main:app --host 0.0.0.0 --port 9527 --reload
```

### 步骤7: 访问API文档

启动成功后，访问以下地址：

- **Swagger文档**: http://localhost:9527/docs
- **ReDoc文档**: http://localhost:9527/redoc
- **API基础路径**: http://localhost:9527/api

### 常见问题

#### 1. 数据库连接失败
- 检查MySQL服务是否启动
- 检查 `.env` 文件中的数据库配置是否正确
- 检查MySQL用户是否有权限访问数据库

#### 2. 迁移失败
- 确保数据库已创建
- 检查Alembic配置是否正确
- 查看 `alembic/env.py` 是否使用了正确的数据库连接

#### 3. 端口被占用
- 修改 `.env` 文件中的 `SERVER_PORT` 配置
- 或者使用其他端口启动：`uvicorn main:app --port 8080`

### 开发建议

1. **使用虚拟环境**:
   ```bash
   python -m venv venv
   # Windows
   venv\Scripts\activate
   # Linux/Mac
   source venv/bin/activate
   ```

2. **代码格式化**:
   ```bash
   black .
   isort .
   ```

3. **类型检查**:
   ```bash
   mypy app/
   ```

---

## 📝 注意事项

1. **生产环境配置**:
   - 修改 `SECRET_KEY` 为强随机字符串
   - 设置 `DEBUG=False`
   - 配置正确的 `BACKEND_CORS_ORIGINS`
   - 使用强密码保护数据库

2. **数据库备份**:
   - 定期备份MySQL数据库
   - 使用 `mysqldump` 进行备份

3. **性能优化**:
   - 根据实际情况调整数据库连接池大小
   - 配置Redis缓存（如果使用）
   - 优化数据库索引

---

## 🔗 相关文档

- [API设计文档](api_design.md)
- [项目结构文档](project_structure.md)
- [后端README](backend/README.md)

